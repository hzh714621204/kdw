<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>停用原后台 | 深圳市科达威</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="备份数据库
执行SQL
整理月表主键 本地测试15个小时
`sql
set nocount off
declare @max int,@idx int,@name varchar(50),@type varchar(2),@pid int,@tb varchar(20),@sql varchar(999)
select ROW_NUMBER() o ...">
    <link rel="preload" href="/kdw/assets/css/0.styles.eb448a25.css" as="style"><link rel="preload" href="/kdw/assets/js/app.a87da991.js" as="script"><link rel="preload" href="/kdw/assets/js/6.e4225e10.js" as="script"><link rel="preload" href="/kdw/assets/js/3.5c8bc695.js" as="script"><link rel="preload" href="/kdw/assets/js/15.e3c22f6e.js" as="script"><link rel="prefetch" href="/kdw/assets/js/10.8a5cfa1e.js"><link rel="prefetch" href="/kdw/assets/js/11.4c8e1e51.js"><link rel="prefetch" href="/kdw/assets/js/12.2534ad7e.js"><link rel="prefetch" href="/kdw/assets/js/13.e62a1fdf.js"><link rel="prefetch" href="/kdw/assets/js/14.7146c883.js"><link rel="prefetch" href="/kdw/assets/js/16.b7729c6f.js"><link rel="prefetch" href="/kdw/assets/js/4.6b3f57a4.js"><link rel="prefetch" href="/kdw/assets/js/5.1fb90bc1.js"><link rel="prefetch" href="/kdw/assets/js/7.4950006e.js"><link rel="prefetch" href="/kdw/assets/js/8.9412132e.js"><link rel="prefetch" href="/kdw/assets/js/9.4ee22c9f.js"><link rel="prefetch" href="/kdw/assets/js/vuejs-paginate.46939081.js">
    <link rel="stylesheet" href="/kdw/assets/css/0.styles.eb448a25.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/kdw/" class="nav-link home-link">深圳市科达威 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/kdw/" class="nav-link">材料文件</a></li><li class="nav-item"><a href="/kdw/tag/" class="nav-link">统计</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/kdw/" class="nav-link mobile-home-link">深圳市科达威 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/kdw/" class="nav-link">材料文件</a></li><li class="mobile-nav-item"><a href="/kdw/tag/" class="nav-link">统计</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">林晓斌</span> <span itemprop="address">   in 深圳</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-4-12">
      Sun Apr 12 2020
    </time></div> <!----></div></header> <div itemprop="articleBody" class="content__default"><h1 id="停用原后台"><a href="#停用原后台" class="header-anchor">#</a> 停用原后台</h1> <h1 id="备份数据库"><a href="#备份数据库" class="header-anchor">#</a> 备份数据库</h1> <h1 id="执行sql"><a href="#执行sql" class="header-anchor">#</a> 执行SQL</h1> <h2 id="整理月表主键-本地测试15个小时"><a href="#整理月表主键-本地测试15个小时" class="header-anchor">#</a> 整理月表主键 本地测试15个小时</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">set</span> nocount <span class="token keyword">off</span>
<span class="token keyword">declare</span> <span class="token variable">@max</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@idx</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@name</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@type</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@pid</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@tb</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@sql</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> name<span class="token punctuation">)</span> idx<span class="token punctuation">,</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>xtype<span class="token punctuation">,</span>parent_obj <span class="token keyword">into</span> <span class="token comment">#t from sysobjects where name like '%T_rec_20%'</span>
<span class="token keyword">select</span> <span class="token variable">@max</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@idx</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">from</span> <span class="token comment">#t</span>
<span class="token keyword">while</span> <span class="token variable">@idx</span> <span class="token operator">&lt;=</span> <span class="token variable">@max</span>
<span class="token keyword">begin</span>
  <span class="token keyword">select</span> <span class="token variable">@name</span><span class="token operator">=</span>name<span class="token punctuation">,</span><span class="token variable">@type</span><span class="token operator">=</span>xtype<span class="token punctuation">,</span><span class="token variable">@pid</span><span class="token operator">=</span>parent_obj <span class="token keyword">from</span> <span class="token comment">#t where idx=@idx</span>
  <span class="token keyword">print</span> <span class="token string">'当前处理对象'</span><span class="token operator">+</span><span class="token variable">@type</span><span class="token operator">+</span><span class="token string">'___'</span><span class="token operator">+</span><span class="token variable">@name</span>
  <span class="token keyword">if</span> <span class="token variable">@type</span> <span class="token operator">=</span> <span class="token string">'PK'</span>
  <span class="token keyword">begin</span>
    <span class="token keyword">select</span> <span class="token variable">@tb</span><span class="token operator">=</span>name <span class="token keyword">from</span> <span class="token comment">#t where id=@pid</span>
	<span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'alter table '</span> <span class="token operator">+</span> <span class="token variable">@tb</span> <span class="token operator">+</span> <span class="token string">' drop constraint '</span> <span class="token operator">+</span> <span class="token variable">@name</span>
	<span class="token keyword">print</span> <span class="token variable">@sql</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">else</span>
  <span class="token keyword">begin</span>
    <span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'alter table '</span> <span class="token operator">+</span> <span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' add unique_key varchar(100)'</span>
	<span class="token keyword">print</span> <span class="token variable">@sql</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'update '</span> <span class="token operator">+</span> <span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' set unique_key=CONCAT(dev_sn,''_'',Convert(varchar(19),event_time,120),''_'',event_type,''_'',pin,''_'',card_no,''_'',event_point_no,''_'',event_point_type)'</span>
	<span class="token keyword">print</span> <span class="token variable">@sql</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
	<span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'declare @tb table (idx int identity(1,1),unique_key varchar(100), id int) insert into @tb select unique_key,max(id) id from '</span> <span class="token operator">+</span> <span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' group by unique_key having count(1)&gt;1 declare @i int,@m int,@id int,@uk varchar(100) select @i=1,@m=max(idx) from @tb while @i&lt;=@m begin select @id=id,@uk=unique_key from @tb where idx=@i delete from '</span><span class="token operator">+</span><span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' where unique_key=@uk and id&lt;@id set @i=@i+1 end'</span>
	<span class="token keyword">print</span> <span class="token variable">@sql</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'alter table '</span> <span class="token operator">+</span> <span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' alter column unique_key varchar(100) not null'</span>
	<span class="token keyword">print</span> <span class="token variable">@sql</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
	<span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'alter table '</span> <span class="token operator">+</span> <span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' add constraint PK_'</span> <span class="token operator">+</span> <span class="token variable">@name</span> <span class="token operator">+</span> <span class="token string">' primary key (unique_key)'</span>
	<span class="token keyword">print</span> <span class="token variable">@sql</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">set</span> <span class="token variable">@idx</span><span class="token operator">=</span><span class="token variable">@idx</span><span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token comment">#t</span>
go
</code></pre></div><h2 id="设备事件类型变更"><a href="#设备事件类型变更" class="header-anchor">#</a> 设备事件类型变更</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">--月表忽略事件类型</span>
<span class="token keyword">truncate</span> <span class="token keyword">table</span> T_acc_device_event_ignore
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">214</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">214</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">206</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event_ignore <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">206</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
go

<span class="token comment">--合并各种设备事件类型</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_device_event <span class="token keyword">add</span> create_type <span class="token keyword">int</span>
go
<span class="token keyword">update</span> T_acc_device_event <span class="token keyword">set</span> create_type<span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event <span class="token punctuation">(</span>event_no<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_level<span class="token punctuation">,</span>create_type<span class="token punctuation">)</span> <span class="token keyword">select</span> event_no<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_level<span class="token punctuation">,</span><span class="token number">2</span> <span class="token keyword">from</span> T_acc_device_event
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event <span class="token punctuation">(</span>event_no<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_level<span class="token punctuation">,</span>create_type<span class="token punctuation">)</span> <span class="token keyword">select</span> event_no<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_level<span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> T_acc_device_event_kdw
<span class="token keyword">insert</span> <span class="token keyword">into</span> T_acc_device_event <span class="token punctuation">(</span>event_no<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_level<span class="token punctuation">,</span>create_type<span class="token punctuation">)</span> <span class="token keyword">select</span> event_no<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_level<span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> T_acc_device_event_kdw
</code></pre></div><h2 id="事件表信息修改"><a href="#事件表信息修改" class="header-anchor">#</a> 事件表信息修改</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_zone <span class="token keyword">add</span> lastEventTime <span class="token keyword">datetime</span>
go
<span class="token keyword">drop</span> <span class="token keyword">table</span> T_tmp_EventSource
go
<span class="token keyword">create</span> <span class="token keyword">table</span> T_tmp_EventSource<span class="token punctuation">(</span>
  Id <span class="token keyword">int</span> <span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  DevId <span class="token keyword">int</span><span class="token punctuation">,</span>
  Content <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  EventType <span class="token keyword">int</span><span class="token punctuation">,</span>
  CreateTime <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">drop</span> <span class="token keyword">table</span> T_acc_transaction_new
go
<span class="token keyword">create</span> <span class="token keyword">table</span> T_acc_transaction_new<span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">,</span>
  unique_key <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  log_id <span class="token keyword">int</span><span class="token punctuation">,</span>
  card_no <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  pin <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  dev_id <span class="token keyword">int</span><span class="token punctuation">,</span>
  door_no <span class="token keyword">int</span><span class="token punctuation">,</span>
  reader_no <span class="token keyword">int</span><span class="token punctuation">,</span>
  reader_status <span class="token keyword">int</span><span class="token punctuation">,</span>
  verify_mode <span class="token keyword">int</span><span class="token punctuation">,</span>
  event_type <span class="token keyword">int</span><span class="token punctuation">,</span>
  event_time <span class="token keyword">datetime</span><span class="token punctuation">,</span>
  create_type <span class="token keyword">int</span><span class="token punctuation">,</span>
  create_time <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">drop</span> <span class="token keyword">table</span> T_acc_transaction_err
go
<span class="token keyword">create</span> <span class="token keyword">table</span> T_acc_transaction_err<span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">,</span>
  unique_key <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  log_id <span class="token keyword">int</span><span class="token punctuation">,</span>
  card_no <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  pin <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  dev_id <span class="token keyword">int</span><span class="token punctuation">,</span>
  door_no <span class="token keyword">int</span><span class="token punctuation">,</span>
  reader_no <span class="token keyword">int</span><span class="token punctuation">,</span>
  reader_status <span class="token keyword">int</span><span class="token punctuation">,</span>
  verify_mode <span class="token keyword">int</span><span class="token punctuation">,</span>
  event_type <span class="token keyword">int</span><span class="token punctuation">,</span>
  event_time <span class="token keyword">datetime</span><span class="token punctuation">,</span>
  create_type <span class="token keyword">int</span><span class="token punctuation">,</span>
  create_time <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
</code></pre></div><h2 id="设备、门数据表修改"><a href="#设备、门数据表修改" class="header-anchor">#</a> 设备、门数据表修改</h2> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">--多卡刷卡间隔</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">add</span> combopen_interval <span class="token keyword">smallint</span>
go
<span class="token comment">--出门按钮状态</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">add</span> door_rex_input <span class="token keyword">smallint</span>
go
<span class="token comment">--出门按钮延时</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">add</span> door_rex_timeout <span class="token keyword">smallint</span>
go
<span class="token comment">--韦根卡格式</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">add</span> wg_type <span class="token keyword">smallint</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">alter</span> <span class="token keyword">column</span> back_lock <span class="token keyword">bit</span>
go
<span class="token keyword">update</span> T_acc_device_verifymode <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'自动识别'</span> <span class="token keyword">where</span> verify_no<span class="token operator">=</span><span class="token number">0</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">drop</span> <span class="token keyword">constraint</span> FK7FB48CAC44609872  
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">alter</span> <span class="token keyword">column</span> combopen_interval <span class="token keyword">smallint</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">alter</span> <span class="token keyword">column</span> back_lock <span class="token keyword">bit</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_door <span class="token keyword">alter</span> <span class="token keyword">column</span> is_combopen_door <span class="token keyword">smallint</span>
go


<span class="token keyword">update</span> T_acc_door <span class="token keyword">set</span> active_timeseg_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>passmode_timeseg_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>lock_delay<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>action_interval<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>sensor_delay<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>back_lock<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>verify_mode<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span>force_pwd<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>supper_pwd<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>in_apb_duration<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>latch_door_type<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>latch_time_out<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span>ext_delay_drivertime<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span>is_combopen_door<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>door_rex_input<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>door_rex_timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>combopen_interval<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>wg_type<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>delay_open_time<span class="token operator">=</span><span class="token number">0</span>
go

<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_device_option <span class="token keyword">add</span> change <span class="token keyword">bit</span> <span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
go

<span class="token keyword">ALTER</span> <span class="token keyword">proc</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>proc_sync_realtime<span class="token punctuation">]</span>
	<span class="token variable">@pin</span> nvarchar<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@readerState</span> <span class="token keyword">smallint</span><span class="token punctuation">,</span>
	<span class="token variable">@cardNo</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@dept</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token variable">@dev</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
	<span class="token variable">@eventTime</span> <span class="token keyword">datetime</span><span class="token punctuation">,</span> <span class="token variable">@reader</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token variable">@createType</span> <span class="token keyword">smallint</span><span class="token punctuation">,</span>
	<span class="token variable">@createTime</span> <span class="token keyword">datetime</span><span class="token punctuation">,</span> <span class="token variable">@events</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">as</span>
<span class="token keyword">begin</span>
    <span class="token keyword">if</span> isnull<span class="token punctuation">(</span><span class="token variable">@pin</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token operator">&lt;&gt;</span><span class="token string">'0'</span> <span class="token operator">and</span> isnull<span class="token punctuation">(</span><span class="token variable">@readerState</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&gt;</span><span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">begin</span>
		<span class="token keyword">declare</span> <span class="token variable">@area</span> <span class="token keyword">int</span>
	    <span class="token keyword">select</span> <span class="token variable">@area</span><span class="token operator">=</span><span class="token keyword">case</span> <span class="token variable">@readerState</span> <span class="token keyword">when</span> <span class="token number">0</span> <span class="token keyword">then</span> rz<span class="token punctuation">.</span>to_zone_id <span class="token keyword">else</span> rz<span class="token punctuation">.</span>from_zone_id <span class="token keyword">end</span> <span class="token keyword">from</span> T_acc_reader_zone rz <span class="token keyword">where</span> rz<span class="token punctuation">.</span>id<span class="token operator">=</span><span class="token variable">@reader</span>
        <span class="token keyword">if</span> <span class="token variable">@readerState</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">and</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> T_rec_realtime <span class="token keyword">where</span> pin<span class="token operator">=</span><span class="token variable">@pin</span> <span class="token operator">and</span> area_id <span class="token operator">=</span> <span class="token variable">@area</span><span class="token punctuation">)</span>
		<span class="token keyword">begin</span>
			<span class="token keyword">insert</span> <span class="token keyword">into</span> T_rec_realtime <span class="token keyword">select</span> <span class="token variable">@pin</span><span class="token punctuation">,</span><span class="token variable">@cardNo</span><span class="token punctuation">,</span><span class="token variable">@dept</span><span class="token punctuation">,</span><span class="token variable">@area</span><span class="token punctuation">,</span><span class="token variable">@dev</span><span class="token punctuation">,</span><span class="token variable">@eventTime</span><span class="token punctuation">,</span><span class="token variable">@reader</span><span class="token punctuation">,</span><span class="token variable">@readerState</span><span class="token punctuation">,</span><span class="token variable">@createType</span><span class="token punctuation">,</span><span class="token variable">@createTime</span><span class="token punctuation">,</span><span class="token variable">@events</span>
		<span class="token keyword">end</span>
		<span class="token keyword">else</span>
		<span class="token keyword">begin</span>
			<span class="token keyword">declare</span> <span class="token variable">@date</span> <span class="token keyword">datetime</span>
			<span class="token keyword">select</span> <span class="token variable">@date</span> <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>rt<span class="token punctuation">.</span>event_Time<span class="token punctuation">)</span> <span class="token keyword">from</span> T_rec_realtime rt <span class="token keyword">where</span> pin<span class="token operator">=</span><span class="token variable">@pin</span> <span class="token operator">and</span> rt<span class="token punctuation">.</span>area_id <span class="token operator">=</span> <span class="token variable">@area</span>
			<span class="token keyword">if</span> <span class="token variable">@createType</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">or</span> DATEADD<span class="token punctuation">(</span>MI<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token variable">@date</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token variable">@eventTime</span>
			<span class="token keyword">begin</span>
				<span class="token keyword">delete</span> <span class="token keyword">from</span> T_rec_realtime <span class="token keyword">where</span> pin<span class="token operator">=</span><span class="token variable">@pin</span> <span class="token operator">and</span> area_id <span class="token operator">=</span> <span class="token variable">@area</span>
				<span class="token keyword">if</span> <span class="token variable">@readerState</span> <span class="token operator">=</span> <span class="token number">0</span>
				<span class="token keyword">begin</span>
					<span class="token keyword">insert</span> <span class="token keyword">into</span> T_rec_realtime <span class="token keyword">select</span> <span class="token variable">@pin</span><span class="token punctuation">,</span><span class="token variable">@cardNo</span><span class="token punctuation">,</span><span class="token variable">@dept</span><span class="token punctuation">,</span><span class="token variable">@area</span><span class="token punctuation">,</span><span class="token variable">@dev</span><span class="token punctuation">,</span><span class="token variable">@eventTime</span><span class="token punctuation">,</span><span class="token variable">@reader</span><span class="token punctuation">,</span><span class="token variable">@readerState</span><span class="token punctuation">,</span><span class="token variable">@createType</span><span class="token punctuation">,</span><span class="token variable">@createTime</span><span class="token punctuation">,</span><span class="token variable">@events</span>
				<span class="token keyword">end</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>


<span class="token keyword">update</span> T_acc_device <span class="token keyword">set</span> category<span class="token operator">=</span><span class="token number">1</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_device <span class="token keyword">add</span> door_count <span class="token keyword">int</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> T_acc_device <span class="token keyword">add</span> reader_count <span class="token keyword">int</span>
go

<span class="token keyword">update</span> t_acc_device <span class="token keyword">set</span> dev_type<span class="token operator">=</span><span class="token string">'ZKTecoAcs'</span> <span class="token keyword">where</span> factory<span class="token operator">=</span><span class="token number">1</span>
go
<span class="token keyword">update</span> t_acc_device <span class="token keyword">set</span> dev_type<span class="token operator">=</span><span class="token string">'KS8000T'</span><span class="token punctuation">,</span>ip_port<span class="token operator">=</span><span class="token number">6767</span> <span class="token keyword">where</span> factory<span class="token operator">=</span><span class="token number">2</span>
go
<span class="token keyword">update</span> T_acc_device <span class="token keyword">set</span> door_count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> T_acc_door <span class="token keyword">where</span> T_acc_door<span class="token punctuation">.</span>ID1<span class="token operator">=</span>T_acc_device<span class="token punctuation">.</span>ID1<span class="token punctuation">)</span>
go
<span class="token keyword">update</span> T_acc_device <span class="token keyword">set</span> reader_count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> T_acc_reader <span class="token keyword">where</span> T_acc_reader<span class="token punctuation">.</span>ID1<span class="token operator">=</span>T_acc_device<span class="token punctuation">.</span>ID1<span class="token punctuation">)</span>
go


将 T_base_area 表的主键 ID1设置为自增列
将 T_acc_device 表的主键 ID1设置为自增列
将 T_acc_door 表的主键 ID2设置为自增列
将 T_acc_reader 表的主键 ID3设置为自增列

</code></pre></div><h1 id="修改已部署的新服务端数据库配置"><a href="#修改已部署的新服务端数据库配置" class="header-anchor">#</a> 修改已部署的新服务端数据库配置</h1> <h1 id="运行新服务端"><a href="#运行新服务端" class="header-anchor">#</a> 运行新服务端</h1> <h1 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h1></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#整理月表主键-本地测试15个小时" title="整理月表主键 本地测试15个小时">整理月表主键 本地测试15个小时</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#设备事件类型变更" title="设备事件类型变更">设备事件类型变更</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#事件表信息修改" title="事件表信息修改">事件表信息修改</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#设备、门数据表修改" title="设备、门数据表修改">设备、门数据表修改</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/kdw/assets/js/app.a87da991.js" defer></script><script src="/kdw/assets/js/6.e4225e10.js" defer></script><script src="/kdw/assets/js/3.5c8bc695.js" defer></script><script src="/kdw/assets/js/15.e3c22f6e.js" defer></script>
  </body>
</html>
